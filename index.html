<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倚歌 - LLM 驱动的古诗词应用</title> 
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    
    <style>
        /* 定义CSS变量区域，用于统一管理页面配色和样式值 */
        :root {
            /* 页面主背景色：淡灰色（#EAEEF1） */
            --bg-color: #EAEEF1;
            /* 次要背景色：稍深的灰蓝色（#D8E3E7），用于分割线和次要区域 */
            --secondary-bg: #D8E3E7;
            /* 主色调：青绿色（#617474），用于强调元素、按钮、导航激活状态等 */
            --accent-green: #617474;
            /* 深色调：深青灰色（#5F7474），用于渐变效果和深色阴影 */
            --accent-dark: #5F7474;
            /* 卡片背景色：米白色（#FDFDFB），用于输入框、输出框、卡片等容器 */
            --card-white: #FDFDFB;
            /* 主要文字颜色：深蓝灰色（#2C3E50），用于正文和主要文字 */
            --text-main: #2C3E50;
            /* 浅色文字颜色：灰色（#7F8C8D），用于次要文字如导航未激活状态 */
            --text-light: #7F8C8D;
            /* 过渡动画效果：0.4秒的平滑过渡，使用贝塞尔曲线使动画更自然 */
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            /* 柔和阴影：用于卡片和元素的立体感，使界面更有层次 */
            --soft-shadow: 0 12px 40px rgba(0,0,0,0.06);
            /* 浅色边框颜色：用于分割线和元素边框，增加细节感 */
            --border-light: rgba(122, 148, 148, 0.15);
        }
        /* 全局样式重置：清除所有元素默认的外边距和内边距，并设置盒模型为border-box */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        /* 页面主体样式设置 */
        body {
            background-color: var(--bg-color);
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
            color: var(--text-main);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }
        /* 标题和古代字体类的统一样式 */
        h1, h2, h3, .ancient-font {
            font-family: 'Noto Serif SC', serif;
            font-weight: 700;
        }
        /* 封面页容器样式 - 应用启动时显示的全屏页面 */
        .landing-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #EAEEF1 100%);
            position: relative;
            overflow: hidden; 
            cursor: pointer;
        }
        /* 涟漪环的基础样式 - 点击时产生的扩散动画效果 */
        .ripple-ring {
            position: absolute;
            border-radius: 50%;
            border: 1.2px solid rgba(97, 116, 116, 0.3);
            background-color: rgba(97, 116, 116, 0.03);
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
            animation: ripple-order-spread 5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            z-index: 1;
        }
        /* 涟漪扩散动画的关键帧定义 */
        @keyframes ripple-order-spread {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(4.5);
                opacity: 0;
            }
        }
        /* 封面页主标题样式 */
        .landing-title {
            font-size: 4rem;
            letter-spacing: 1.2rem;
            margin-bottom: 3rem;
            color: var(--accent-green);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
            user-select: none;
            z-index: 2;
        }
        /* 开始按钮的样式 */
        .btn-start {
            padding: 16px 60px;
            font-size: 1.2rem;
            background-color: var(--card-white);
            border: 1px solid var(--accent-green);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--accent-green);
            letter-spacing: 4px;
            box-shadow: var(--soft-shadow);
            z-index: 10;
        }
        /* 开始按钮的悬停效果 */
        .btn-start:hover {
            background-color: var(--accent-green);
            color: white;
            transform: translateY(-3px);
        }
        /* 主应用容器样式 - 包含导航和主要内容区域 */
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 20px 60px;
        }
        /* 顶部导航栏样式 - 固定在页面顶部 */
        .nav-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 80px;
            background: rgba(234, 238, 241, 0.85);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid var(--border-light);
        }
        /* 导航项样式 */
        .nav-item {
            margin: 0 40px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--text-light);
            transition: var(--transition);
            letter-spacing: 3px;
            position: relative;
        }
        /* 激活状态的导航项样式 */
        .nav-item.active { color: var(--accent-green); }
        /* 导航项激活时的下划线伪元素 */
        .nav-item.active::after {
            content: "";
            position: absolute;
            bottom: -10px; left: 10%; width: 80%; height: 2px;
            background: var(--accent-green);
        }
        /* 主内容区域布局样式 - 使用CSS Grid网格布局 */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 40px;/*输入输出框之间的间距*/
            margin-bottom: 60px;/*输入输出框与推荐阅读的间距*/
        }
        /* 输入框和输出框的共同样式 */
        .input-box, .output-box {
            background: var(--card-white);
            border-radius: 8px;/*输入输出框的圆角*/
            box-shadow: var(--soft-shadow);
            transition: var(--transition);
        }
        /* 输入框专有样式 */
        .input-box {
            padding: 30px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid var(--accent-green);/*右边框的宽度与颜色*/
        }
        /* 文本域（多行输入框）样式 */
        textarea {
            width: 100%;
            height: 150px;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            font-size: 1.25rem;
            line-height: 2;
            font-family: 'Noto Serif SC', serif;
            color: var(--text-main);
        }
        /* 古诗鉴赏模块的文本域样式 */
        .jianshang-module textarea {
            height: 200px;
        }
        /* 标签页切换栏容器样式 */
        .tab-bar {
            display: flex;
            background: #F1F4F6;
            padding: 3px;
            border-radius: 6px 6px 0 0;
        }
        /* 标签页按钮样式 */
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Noto Serif SC', serif;
            color: var(--text-light);
        }
        /* 激活状态的标签页按钮样式 */
        .tab-btn.active {
            background: var(--card-white);
            color: var(--accent-green);
            font-weight: bold;
            border-radius: 6px;
        }
        /* 内容展示区域样式 */
        .content-area {
            padding: 20px 30px 25px;
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        /* 古诗鉴赏模块的内容区域样式 */
        .jianshang-module .content-area {
            min-height: 200px;
            max-height: 350px;
        }
        /* 反馈按钮区域容器样式 */
        .feedback-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #F1F4F6;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }
        /* 反馈按钮（点赞/点踩）基础样式 */
        .feedback-btn {
            background: var(--card-white);
            border: 1px solid #EEE;
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }
        /* 激活状态的反馈按钮样式 */
        .feedback-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }
        /* 请将这段代码放入顶部的 <style> 标签中 */

        /* 1. 首页容器需设置为相对定位，作为视频定位的基准 */
        .landing-page {
            position: relative; /* 确保内部的 absolute 元素以此为准 */
            overflow: hidden;
        }

        /* 2. 视频容器固定到底部 */
        .boat-container {
            position: absolute;
            bottom: 0%;        /* 距离底部的高度 */
            left: 0;
            width: 100%;
            height: 150px;
            z-index: 1;         /* 在背景层 */
            pointer-events: none; /* 确保点击能穿透视频点到按钮 */
        }

        /* 3. 限制视频大小并执行动画 */
        #bgVideo {
            width: 300px;       /* 修正宽度，不再巨型 */
            position: absolute;
            animation: boatMoveLeft 60s linear infinite;
        }

        @keyframes boatMoveLeft {
            /* 进入阶段：从右侧淡入 */
            0% { transform: translateX(110vw) translateY(0px); opacity: 0; }
            10% { transform: translateX(100vw) translateY(0px); opacity: 0.7; }
            90% { transform: translateX(20vw) translateY(0px); opacity: 0.7; }

            100% { transform: translateX(-400px) translateY(0px); opacity: 0; }
        }

        /* 4. 确保文字内容在视频上方 */
        .landing-content {
            position: relative;
            z-index: 10;        /* 确保层级高于视频 */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        
       
        /* 推荐卡片网格容器样式 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 25px;
        }
        /* 单个推荐卡片样式 */
        .card {
            background: var(--card-white);
            padding: 25px;
            border-radius: 12px;
            transition: var(--transition);
        }
        /* 卡片的悬停效果 */
        .card:hover { transform: translateY(-8px); border: 1px solid var(--accent-green); }
        /* 开始分析按钮样式（主操作按钮） */
        .btn-start-analysis {
            padding: 12px 35px;
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-dark) 100%);
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        /* 次要操作按钮样式（用于刷新、随机等功能） */
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* 旋转动画类名 */
        .rotating { animation: spin 0.8s ease-in-out infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 开始赏析按钮动画 */
        @keyframes jianshang-btn-animation {
            0% { transform: scale(1); box-shadow: 0 12px 40px rgba(0,0,0,0.06); }
            50% { transform: scale(1.05); box-shadow: 0 15px 50px rgba(97, 116, 116, 0.2); }
            100% { transform: scale(1); box-shadow: 0 12px 40px rgba(0,0,0,0.06); }
        }
        
        .btn-jianshang-animation { animation: jianshang-btn-animation 0.6s ease-out; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.6s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* Vue指令v-cloak的样式，用于防止Vue初始化时闪烁 */
        [v-cloak] { display: none; }
        
        /* 折叠菜单样式 */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 10px;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
        }
        
        .nav-dropdown {
            position: relative;
        }
        
        .nav-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(234, 238, 241, 0.95);
            backdrop-filter: blur(15px);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 101;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .nav-dropdown-content.show {
            display: block;
        }
        
        .nav-dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-light);
            transition: var(--transition);
            text-decoration: none;
            display: block;
        }
        
        .nav-dropdown-item:hover,
        .nav-dropdown-item.active {
            color: var(--accent-green);
            background-color: rgba(245, 245, 245, 0.5);
        }
        
        /* 移动端登录页面样式 */
        .mobile-landing-content {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        /* 响应式设计：当屏幕宽度小于850px时的样式调整 */
        @media (max-width: 850px) {
            .main-layout { grid-template-columns: 1fr; }
            .card-grid { grid-template-columns: 1fr; }
            
            .nav-item {
                margin: 0 15px;
                font-size: 1.2rem;
            }
            
            .nav-menu {
                display: none;
            }
            
            .mobile-nav-toggle {
                display: block;
            }
            
            .nav-dropdown {
                position: static;
            }
            
            .nav-dropdown-content {
                top: 100%;
                left: 0;
                right: 0;
                width: auto;
                min-width: unset;
                margin-top: 10px;
            }
            
            /* 移动端登陆页面显示 */
            .desktop-landing-content {
                display: none !important;
            }
            
            .mobile-landing-content {
                display: flex !important;
            }
            
            .landing-title {
                font-size: 2.5rem !important;
                letter-spacing: 1rem !important;
                margin-right: 0 !important;
            }
            
            .btn-start {
                padding: 12px 30px !important;
                font-size: 1rem !important;
                letter-spacing: 1px !important;
            }
        }
        
        /* 当屏幕宽度小于600px时进一步调整 */
        @media (max-width: 600px) {
            .nav-header {
                padding: 0 10px;
            }
            
            .nav-item {
                margin: 0 10px;
                font-size: 1.1rem;
            }
            
            .app-container {
                padding: 90px 15px 50px;
            }
            
            .landing-title {
                font-size: 2rem !important;
                letter-spacing: 0.8rem !important;
            }
            
            .btn-start {
                padding: 10px 25px !important;
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>

<body>
    <!-- 音频元素：用于播放背景音乐 -->
    <audio id="bgMusic" src="./bgm.mp3" loop preload="auto" autoplay></audio>
    <div id="app" v-cloak>
        <transition name="fade" mode="out-in">
            <div v-if="page === 'start'" class="landing-page" @mousedown="triggerRipple" @mousemove="triggerRipple" key="start">
                <!-- 视频：泛舟画面 -->
                <div class="boat-container">
                    <video id="bgVideo" src="video_compressed.mp4" autoplay loop muted playsinline></video>
                </div>
                
                <!-- 桌面端登录内容 -->
                <div class="landing-content desktop-landing-content">
                    <img src="YIGE.png" alt="Logo" style="max-width: 800px; margin-bottom: 1rem;">
                    <h1 class="landing-title" style="font-size: 3rem; letter-spacing: 3rem; margin-right: -3rem; margin-bottom: 1.5rem;">古诗词赏析</h1>
                    <button class="btn-start" style="padding: 12px 40px; font-size: 1rem; letter-spacing: 2px;" @click.stop="page = 'app'">探 寻</button>
                </div>
                
                <!-- 移动端登录内容 -->
                <div class="mobile-landing-content">
                    <img src="YIGE_UD.png" alt="Logo" style="max-width: 300px; height: 50%; margin-bottom: 1rem;">
                    <h1 class="landing-title" style="font-size: 2rem; letter-spacing: 2rem; align-items: center; margin-right: -2rem; margin-bottom: 1.5rem;">古诗词赏析</h1>
                    <button class="btn-start" style="padding: 12px 40px; font-size: 1rem; letter-spacing: 2px;" @click.stop="page = 'app'">探 寻</button>
                </div> 
            </div><div v-else key="app">
                <nav class="nav-header">
                    <div class="nav-menu">
                        <div class="nav-item" :class="{active: currentModule === 'jianshang'}" @click="currentModule = 'jianshang'">古诗鉴赏</div>
                    </div>
                    
                    <!-- 移动端下拉菜单 -->
                    <div class="nav-dropdown" v-if="isMobileView">
                        <button class="mobile-nav-toggle" @click="toggleMobileMenu">
                            <i :class="['fa-solid', mobileMenuOpen ? 'fa-times' : 'fa-bars']"></i>
                        </button>
                        <div class="nav-dropdown-content" :class="{show: mobileMenuOpen}">
                            <div class="nav-dropdown-item" :class="{active: currentModule === 'jianshang'}" @click="switchModuleAndClose('jianshang')">古诗鉴赏</div>
                        </div>
                    </div>
                    
                    <div style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 10px;">
                        <button class="btn-secondary" 
                                style="background: rgba(234, 238, 241, 0.9); border: 1px solid var(--border-light); min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                                @click="toggleMusic" 
                                title="{{ isMusicPlaying ? '暂停音乐' : '播放音乐' }}">
                            <i :class="['fa-solid', isMusicPlaying ? 'fa-pause' : 'fa-play']" style="font-size: 1.1rem;"></i>
                        </button>
                        <div style="color: var(--accent-green); font-size: 0.9rem; display: flex; align-items: center; gap: 5px;">
                            <i class="fa-solid fa-music"></i>
                            <span>{{ isMusicPlaying ? '播放中' : '已暂停' }}</span>
                        </div>
                    </div>
                </nav>

                <main class="app-container">
                    <!-- 提示文字 -->
                    <div style="text-align: center; margin-bottom: 30px; color: var(--accent-green); font-family: 'Noto Serif SC', serif;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-quote-left"></i> {{ currentModuleText }} <i class="fa-solid fa-quote-right"></i>
                        </p>
                    </div>
                    
                    <!-- 只保留古诗鉴赏模块 -->
                    <div :class="['main-layout', {'jianshang-module': currentModule === 'jianshang'}]">
                        <div class="input-box">
                            <textarea v-model="userInput" placeholder="在此铺陈墨宝，静候解析..."></textarea>
                            <div class="action-bar" style="display: flex; justify-content: flex-end; margin-top: 130px;">
                                <button class="btn-secondary" style="margin-right: auto;" @click="handleRandomClick" :disabled="isPoemLoading || isLoading">
                                    <i :class="['fa-solid', 'fa-wand-magic-sparkles', { 'rotating': isPoemLoading }]"></i> 
                                    {{ isPoemLoading ? '寻觅中...' : '偶遇佳作' }}
                                </button>
                                <button class="btn-start-analysis" @click="startAnalysis" :disabled="(!userInput.trim() || isLoading)">
                                    {{ isLoading ? '推敲中...' : '开始赏析' }}
                                </button>
                            </div>
                        </div>

                        <div class="output-box">
                            <div class="tab-bar">
                                <button v-for="tab in currentTabs" 
                                        :class="['tab-btn', {active: activeTab === tab}]"
                                        @click="activeTab = tab">
                                    {{ tab }}
                                </button>
                            </div>
                            <div class="content-area">
                                <div v-if="!hasStartedAnalysis" style="color: #BDC3C7; text-align: center; margin-top: 80px;">
                                    <p style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"><i class="fa-solid fa-scroll"></i></p>
                                    <p>待君输入诗句，方能品鉴其中意境</p>
                                </div>
                                
                                <div v-else-if="isLoading" style="color: var(--accent-green); text-align: center; margin-top: 50px;">
                                    <i class="fa-solid fa-feather-pointed fa-spin"></i> 正在翻阅古籍，请稍候...
                                </div>

                                <div v-else-if="errorMessage" style="color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 8px;">
                                    <i class="fa-solid fa-circle-exclamation"></i> {{ errorMessage }}
                                </div>

                                <div v-else>
                                    <div style="white-space: pre-wrap; animation: fadeIn 0.8s ease;">{{ outputContent }}</div>
                                    
                                    <div v-if="outputContent && traceId" class="feedback-container">
                                        <span style="font-size: 0.85rem; color: #999;">
                                            {{ isFeedbackLoading ? '记录中...' : '此番解析可还中意？' }}
                                        </span>
                                        <button class="feedback-btn" :class="{active: feedbackStatus === 'good'}" 
                                                @click="submitFeedback(true)" :disabled="feedbackStatus !== null || isFeedbackLoading">
                                            <i :class="['fa-solid', feedbackStatus === 'good' ? 'fa-check' : 'fa-thumbs-up']"></i> 精准
                                        </button>
                                        <button class="feedback-btn" :class="{active: feedbackStatus === 'bad'}" 
                                                @click="submitFeedback(false)" :disabled="feedbackStatus !== null || isFeedbackLoading">
                                            <i class="fa-solid fa-thumbs-down"></i> 欠妥
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 推荐卡片区域：仅在古诗鉴赏模块显示 -->
                    <section class="card-section">
                        <div v-if="showFullPoem">
                            <button class="btn-secondary" style="margin-bottom: 20px;" @click="showFullPoem = false; fullPoemContent = '';">
                                <i class="fa-solid fa-arrow-left"></i> 返回推荐
                            </button>
                            <h3 class="ancient-font" style="font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center;">
                                <span style="width: 4px; height: 24px; background: var(--accent-green); display: inline-block; margin-right: 12px;"></span>
                                {{ fullPoemTitle }}
                            </h3>
                            <div class="card" style="cursor: default;">
                                <small style="color: var(--accent-green); display: block; margin-bottom: 15px;">{{ fullPoemAuthor }}</small>
                                <p style="font-size: 1.2rem; line-height: 2; white-space: pre-wrap;">{{ fullPoemContent }}</p>
                            </div>
                        </div>
                        <div v-else>
                            <h3 class="ancient-font" style="font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center;">
                                <span style="width: 4px; height: 24px; background: var(--accent-green); display: inline-block; margin-right: 12px;"></span>
                                推荐品读
                            </h3>
                            <div class="card-grid">
                                <div class="card" v-for="item in currentList" :key="item.title" 
                                     style="cursor: pointer;" @click="viewFullPoem(item)">
                                    <h4>{{ item.title }}</h4>
                                    <small style="color: var(--accent-green); display: block; margin-bottom: 10px;">{{ item.author }}</small>
                                    <p>{{ item.desc }}</p>
                                </div>
                            </div>
                            <button class="btn-secondary" style="margin: 40px auto;" @click="handleRefreshList" :disabled="isRefreshing">
                                <i :class="['fa-solid', 'fa-rotate', { 'rotating': isRefreshing }]"></i> 
                                {{ isRefreshing ? '寻觅中...' : '换一批' }}
                            </button>
                        </div>
                    </section>
                </main>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;
        const API_BASE_URL = '';

        createApp({
            setup() {
                const page = ref('start');
                const currentModule = ref('jianshang'); // 只保留古诗鉴赏模块
                const activeTab = ref('');
                const userInput = ref('');
                const outputContent = ref('');
                
                const isLoading = ref(false); 
                const isPoemLoading = ref(false); 
                const isRefreshing = ref(false); 
                const isFeedbackLoading = ref(false);

                const errorMessage = ref('');
                const currentList = ref([]);
                const traceId = ref('');
                const hasStartedAnalysis = ref(false);
                const feedbackStatus = ref(null);
                
                // 全诗详情页相关变量
                const showFullPoem = ref(false);
                const fullPoemTitle = ref('');
                const fullPoemAuthor = ref('');
                const fullPoemContent = ref('');
                
                // 音乐控制相关变量
                const isMusicPlaying = ref(false);
                const bgMusic = ref(null);
                
                // 响应式相关变量
                const windowWidth = ref(window.innerWidth);
                const mobileMenuOpen = ref(false);
                
                const tabsMap = {
                    jianshang: ['翻译', '赏析', '作者', '创作背景']
                };

                const currentTabs = computed(() => {
                    const tabs = tabsMap[currentModule.value];
                    if (!tabs.includes(activeTab.value)) activeTab.value = tabs[0];
                    return tabs;
                });
                
                // 根据当前模块返回不同的提示文字
                const currentModuleText = computed(() => {
                    switch (currentModule.value) {
                        case 'jianshang':
                            return '寄蜉蝣于天地，渺沧海之一粟';
                    }
                });
                
                // 计算是否为移动端视图
                const isMobileView = computed(() => {
                    return windowWidth.value <= 850;
                });

                // 涟漪效果触发函数
                let lastRippleTime = 0;
                const triggerRipple = (event) => {
                    // 添加节流，限制涟漪触发频率
                    const now = Date.now();
                    if (now - lastRippleTime < 600) {
                        return;
                    }
                    lastRippleTime = now;
                    
                    const container = event.currentTarget;
                    const rect = container.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    const size = 180; 

                    for (let i = 0; i < 2; i++) {
                        setTimeout(() => {
                            const ring = document.createElement('span');
                            ring.className = 'ripple-ring';
                            
                            ring.style.width = ring.style.height = `${size}px`;
                            ring.style.left = `${x}px`;
                            ring.style.top = `${y}px`;
                            
                            container.appendChild(ring);

                            ring.addEventListener('animationend', () => {
                                ring.remove();
                            });
                        }, i * 200);
                    }
                };
                
                // 监听窗口大小变化
                const handleResize = () => {
                    windowWidth.value = window.innerWidth;
                    // 如果窗口变宽，关闭移动端菜单
                    if (windowWidth.value > 850) {
                        mobileMenuOpen.value = false;
                    }
                };

                // 核心分析函数
                const handleAnalysis = async () => {
                    if (!userInput.value.trim()) return;
                    isLoading.value = true;
                    errorMessage.value = '';
                    feedbackStatus.value = null;

                    try {
                        let endpoint = '';
                        let body = { content: userInput.value };

                        if (currentModule.value === 'jianshang') {
                            if (activeTab.value === '翻译') { endpoint = '/api/v1/poem/translate'; body.query = []; }
                            else if (activeTab.value === '赏析') endpoint = '/api/v1/poem/appreciation';
                            else if (activeTab.value === '作者') {
                                endpoint = '/api/v1/poem/details/author-predict';
                                body = { content: userInput.value };
                            } else endpoint = '/api/v1/poem/details/background';
                        }

                        const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const data = await res.json();
                        
                        if (data) {
                            traceId.value = data.trace_id || '';
                            if (activeTab.value === '翻译') outputContent.value = data.result.join('\n');
                            else if (activeTab.value === '作者') outputContent.value = `朝代：${data.dynasty}\n作者：${data.author}\n${data.introduction ? '简介：' + data.introduction : ''}`;
                            else outputContent.value = data.result;
                        }
                    } catch (e) {
                        errorMessage.value = "思绪中断，请稍后再试";
                    } finally {
                        isLoading.value = false;
                        // 分析完成后更新推荐列表
                        if (userInput.value.trim()) {
                            updateRecommendList(userInput.value);
                        }
                    }
                };

                const startAnalysis = () => {
                    hasStartedAnalysis.value = true;
                    
                    // 添加按钮动画效果
                    const btnClass = currentModule.value === 'jianshang' ? 'btn-jianshang-animation' : '';
                    
                    // 查找当前模块的主要按钮并添加动画类
                    setTimeout(() => {
                        const btn = document.querySelector('.btn-start-analysis');
                        if (btn) {
                            btn.classList.add(btnClass);
                            // 动画结束后移除类，以便下次点击时可以再次触发
                            setTimeout(() => {
                                btn.classList.remove(btnClass);
                            }, 800);
                        }
                    }, 10);
                    
                    handleAnalysis();
                };

                // 随机诗词函数
                const handleRandomClick = async () => {
                    isPoemLoading.value = true;
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/v1/poem/random`);
                        const data = await res.json();
                        if (data && data.content) {
                            userInput.value = data.content;
                            hasStartedAnalysis.value = false; 
                            outputContent.value = '';
                        }
                    } finally {
                        isPoemLoading.value = false;
                    }
                };

                // 提交反馈函数
                const submitFeedback = async (isGood) => {
                    if (!traceId.value || isFeedbackLoading.value) return;
                    isFeedbackLoading.value = true;
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/v1/feedback/submit`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                trace_id: traceId.value,
                                good: isGood,
                                comment: isGood ? "满意" : "不准确"
                            })
                        });
                        const data = await res.json();
                        if (data && data.status === 'OK') feedbackStatus.value = isGood ? 'good' : 'bad';
                    } catch (e) {
                        console.error("反馈失败", e);
                    } finally {
                        isFeedbackLoading.value = false;
                    }
                };

                // 查看全诗详情函数
                const viewFullPoem = (item) => {
                    showFullPoem.value = true;
                    fullPoemTitle.value = item.title;
                    fullPoemAuthor.value = item.author;
                    fullPoemContent.value = item.fullContent || item.desc;
                };
                
                // 音乐控制函数
                const initMusic = () => {
                    bgMusic.value = document.getElementById('bgMusic');
                    if (bgMusic.value) {
                        bgMusic.value.volume = 1; // 设置音量为100%
                        // 立即尝试播放音乐
                        bgMusic.value.play().then(() => {
                            isMusicPlaying.value = true;
                            console.log('音乐自动播放成功');
                        }).catch(e => {
                            console.error('自动播放失败:', e);
                            // 如果自动播放失败，设置用户交互检测
                            setupAutoPlay();
                        });
                    }
                };
                
                const playMusic = () => {
                    if (!bgMusic.value) {
                        initMusic();
                    }
                    if (bgMusic.value && !isMusicPlaying.value) {
                        bgMusic.value.play().then(() => {
                            isMusicPlaying.value = true;
                        }).catch(e => {
                            console.error('音频播放失败:', e);
                        });
                    }
                };
                
                const toggleMusic = () => {
                    if (!bgMusic.value) {
                        initMusic();
                    }
                    if (isMusicPlaying.value) {
                        bgMusic.value.pause();
                        isMusicPlaying.value = false;
                    } else {
                        playMusic();
                    }
                };
                
                // 监听用户交互，触发自动播放
                const setupAutoPlay = () => {
                    const userInteractEvents = ['click', 'touchstart', 'keydown', 'mousedown'];
                    
                    const handleFirstInteraction = () => {
                        playMusic();
                        // 移除所有事件监听器
                        userInteractEvents.forEach(event => {
                            document.removeEventListener(event, handleFirstInteraction);
                        });
                    };
                    
                    // 添加事件监听器
                    userInteractEvents.forEach(event => {
                        document.addEventListener(event, handleFirstInteraction, { once: true });
                    });
                };

                // 刷新推荐列表函数 - 换一批：调用三次random接口
                const handleRefreshList = async () => {
                    isRefreshing.value = true;
                    try {
                        // 调用三次random接口获取随机古诗
                        const randomPoems = await Promise.all(
                            Array.from({ length: 3 }, () => 
                                fetch(`${API_BASE_URL}/api/v1/poem/random`).then(r => r.json())
                            )
                        );
                        
                        // 处理返回结果
                        currentList.value = randomPoems.map(poem => ({
                            id: poem.id || Math.random(), // 确保有唯一ID
                            title: poem.title || '未知标题',
                            author: poem.author || '未知作者',
                            desc: poem.content ? poem.content.slice(0, 45) + '...' : '暂无内容',
                            fullContent: poem.content || ''
                        }));
                    } catch (error) {
                        console.error('获取随机古诗失败:', error);
                    } finally {
                        setTimeout(() => isRefreshing.value = false, 600);
                    }
                };
                
                // 推荐列表函数 - 基于用户输入
                const updateRecommendList = async (inputContent) => {
                    try {
                        // 调用recommend接口
                        const res = await fetch(`${API_BASE_URL}/api/v1/poem/recommend`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: inputContent, limit: 3 })
                        });
                        const data = await res.json();
                        if (data && data.status === 'OK') {
                            // 调用poem details接口获取详细信息
                            const details = await Promise.all(data.result.map(id => 
                                fetch(`${API_BASE_URL}/api/v1/poem/details?id=${id}`).then(r => r.json())
                            ));
                            currentList.value = details.map(d => ({ 
                                id: d.id,
                                title: d.title, 
                                author: d.author, 
                                desc: d.content.slice(0, 45) + '...',
                                fullContent: d.content
                            }));
                        }
                    } catch (error) {
                        console.error('获取推荐古诗失败:', error);
                    }
                };
                
                // 移动端菜单切换
                const toggleMobileMenu = () => {
                    mobileMenuOpen.value = !mobileMenuOpen.value;
                };
                
                // 切换模块并关闭移动端菜单
                const switchModuleAndClose = (module) => {
                    currentModule.value = module;
                    mobileMenuOpen.value = false;
                };

                watch(activeTab, () => { if (hasStartedAnalysis.value) handleAnalysis(); });
                watch(currentModule, () => { hasStartedAnalysis.value = false; outputContent.value = ''; userInput.value = ''; });

                // 组件挂载时添加事件监听器
                onMounted(() => {
                    window.addEventListener('resize', handleResize);
                });
                
                // 组件卸载时移除事件监听器
                onUnmounted(() => {
                    window.removeEventListener('resize', handleResize);
                });

                handleRefreshList();
                initMusic(); // 初始化音乐控制
                setupAutoPlay(); // 设置自动播放

                return {
                    page, currentModule, activeTab, userInput, outputContent,
                    isLoading, isPoemLoading, isRefreshing, isFeedbackLoading,
                    errorMessage, currentTabs, currentList, traceId,
                    hasStartedAnalysis, feedbackStatus,
                    showFullPoem, fullPoemTitle, fullPoemAuthor, fullPoemContent,
                    isMusicPlaying, bgMusic, currentModuleText,
                    startAnalysis, handleRandomClick, submitFeedback, handleRefreshList, updateRecommendList,
                    triggerRipple, viewFullPoem, toggleMusic,
                    windowWidth, isMobileView, mobileMenuOpen, toggleMobileMenu, switchModuleAndClose
                }
            }
        }).mount('#app')
    </script>
</body>
</html>